#!/usr/bin/env bash

### Konfiguration
APP_DIR="/home/astier/Projekte/linko-wiki"
VENV_PY="$APP_DIR/.venv/bin/python"
APP_FILE="$APP_DIR/bin/srv.py"
PID_FILE="$APP_DIR/linko-wiki.pid"
LOG_FILE="$APP_DIR/linko-wiki.log"

### Funktionen
start() {
    if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        echo "linko-wiki läuft bereits (PID $(cat "$PID_FILE"))"
        exit 0
    fi

    echo "Starte linko-wiki …"
    cd "$APP_DIR" || exit 1

    nohup "$VENV_PY" "$APP_FILE" \
        >> "$LOG_FILE" 2>&1 &

    echo $! > "$PID_FILE"
    sleep 1

    if kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        echo "linko-wiki gestartet (PID $(cat "$PID_FILE"))"
    else
        echo "Fehler beim Start – siehe Log:"
        tail -n 20 "$LOG_FILE"
        rm -f "$PID_FILE"
        exit 1
    fi
}

stop() {
    if [[ ! -f "$PID_FILE" ]]; then
        echo "linko-wiki läuft nicht"
        exit 0
    fi

    PID=$(cat "$PID_FILE")

    if kill -0 "$PID" 2>/dev/null; then
        echo "Stoppe linko-wiki (PID $PID) …"
        kill "$PID"
        sleep 2

        if kill -0 "$PID" 2>/dev/null; then
            echo "Prozess reagiert nicht – SIGKILL"
            kill -9 "$PID"
        fi
    fi

    rm -f "$PID_FILE"
    echo "linko-wiki gestoppt"
}

status() {
    if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        echo "linko-wiki läuft (PID $(cat "$PID_FILE"))"
    else
        echo "linko-wiki läuft nicht"
    fi
}

### CLI
case "$1" in
    start)  start ;;
    stop)   stop ;;
    restart)
        stop
        start
        ;;
    status) status ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
